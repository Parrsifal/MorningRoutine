# Fastfile for Morning Routine
# https://docs.fastlane.tools

default_platform(:ios)

platform :ios do

  desc "Upload metadata and screenshots to App Store Connect"
  lane :upload_metadata do
    key_path = File.join(ENV["CM_BUILD_DIR"] || Dir.pwd, "fastlane", "keys", "AuthKey.p8")

    UI.message("Loading API key from: #{key_path}")

    unless File.exist?(key_path)
      UI.user_error!("API key file not found at #{key_path}. Please add your AuthKey.p8 to fastlane/keys/")
    end

    # ⚠️ ВНИМАНИЕ: Проверь эти значения!
    # Key ID и Issuer ID должны быть из твоего App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"] || "22U4SFDZ2F",  # ✅ ОБНОВЛЕНО!
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"] || "a5b4e87a-8719-4c7e-8694-1e3e63a152aa",  # ✅ ОБНОВЛЕНО!
      key_filepath: key_path,
      in_house: false
    )

    UI.success("API key loaded successfully!")

    deliver(
      api_key: api_key,
      app_identifier: "com.morningRoutine",  # ← Bundle ID из твоего проекта
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots",
      skip_binary_upload: true,
      skip_app_version_update: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      overwrite_screenshots: true,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false
    )
  end

end
